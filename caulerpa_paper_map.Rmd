---
title: "caulerpa_paper_map"
output: html_document
date: "2025-08-05"
editor_options: 
  chunk_output_type: console
---


Code developed using R version 4.5

Remote code repository location: https://github.com/KHilliam96/

# Aim
-   create interactive caulerpa map

# To Do
-   sort location and site names in metadata to merge 

# Important Notes
-   

# Labelling System

-   .df, .list, .dist etc at the end of an object signify what class it is
-   iterations of an object where no significant change has occured will be noted numerically i.e., .df/.df2/.df3
-   df with spatial information and sf or sp objects will contain the coordinate system in their name, e.g., buffer_WGS1984.sf once transformed. But will not in first instance (buffer.df)

# Setup

```{r setup, include = FALSE}
# https://bookdown.org/yihui/rmarkdown/r-code.html
knitr::opts_chunk$set(echo = FALSE, message = FALSE,
  warnings = FALSE, error = FALSE)

```

```{r packages, include = FALSE}
# Clear the space
rm(list = ls()) # clear memory

# Load packages
# Install and load pacman
if (!requireNamespace("pacman", quietly = TRUE)) {
  message("pacman is being installed and has been loaded.")
  install.packages("pacman")
  library(pacman)
} else {
  message("pacman is installed and has been loaded.")
  library(pacman)
}

# Data Wrangling
pacman::p_load(tidyverse)

# Spatial
pacman::p_load(sf)

# Plotting
pacman::p_load(leaflet)
pacman::p_load(leaflet.extras)

```

```{r Set up versioning and outputs, include = FALSE}
options(scipen = 999)
write_outputs <- FALSE
version <- "_V1"

project_directory <- "/home/khill/Documents/science/caulerpa_paper_2025"
```

```{r File Locations, include = FALSE}
setwd(project_directory)
getwd()

# Get the location of our input data (this folder was created manually when
# saving the data)

inputs <- file.path(project_directory, "1_raw_inputs")

# All other folders can be created in the code (note, will only do this once)

# Create a directory to store current work in progress and files created in R

wip_r_directory <- file.path(project_directory, "2_wip_r")

if (!"work_in_progress_R" %in% basename(list.dirs(project_directory))) { # Check folder has not already been created
  
  dir.create(wip_r_directory)
  
  print("creating directory to store wip files")
  
} else {
  
  print("found existing wip directory")
  
}

# Create a directory to store current work in progress and files created in GIS

wip_gis_directory <- file.path(project_directory, "3_wip_non_code")

if (!"work_in_progress_GIS" %in% basename(list.dirs(project_directory))) { # Check folder has not already been created
  
  dir.create(wip_gis_directory)
  
  print("creating directory to store GIS wip files")
  
} else {
  
  print("found existing non-code wip directory")
  
}

# Create a directory to store all finalised outputs

processed_output_directory <- file.path(project_directory, "4_clean_outputs")

if (!"processed_outputs" %in% basename(list.dirs(project_directory))) { # Check folder has not already been created
  
  dir.create(processed_output_directory)
  
  print("creating directory to store outputs")
  
} else {
  
  print("found existing outputs directory")
  
}

# Create a directory to store all finalised figures

figure_directory <- file.path(project_directory, "5_manuscript_figures")

if (!"5_manuscript_figures" %in% basename(list.dirs(project_directory))) { # Check folder has not already been created
  
  dir.create(figure_directory)
  
  print("creating directory to store figures")
  
} else {
  
  print("found existing figure directory")
  
  
}  

# Create a directory to store all supplementary figures

supporting_directory <- file.path(project_directory, "6_supporting_figures")

if (!"6_supporting_figures" %in% basename(list.dirs(project_directory))) { # Check folder has not already been created
  
  dir.create(supporting_directory)
  
  print("creating directory to store figures")
  
} else {
  
  print("found existing supporting directory")
  
  
}
  
```

# Import data

```{r Import Survey Reachability Network}
survey_reach_nodes.sf <- st_read(file.path(inputs, 
                                           "rec_net_caulerpa_V4.0_nodes.shp"))
  
survey_reach_edges.sf <- st_read(file.path(inputs, 
                                          "rec_net_caulerpa_V4.0_edges.shp"))

```

```{r Import Survey Downstream Network}
survey_down_nodes.sf <- st_read(file.path(inputs, 
                                         "rec_net_caulerpa_downstream_5kn_V4.0_nodes.shp"))

survey_down_edges.sf <- st_read(file.path(inputs,
                                          "rec_net_caulerpa_downstream_5kn_V4.0_edges.shp"))

```

```{r Import AIS Reachability Network}
ais_reach_nodes.sf <- st_read(file.path(inputs,
                                        "AIS_net_GBI_16_06_2023_NZTM_nodes.shp"))

ais_reach_edges.sf <- st_read(file.path(inputs,
                                        "AIS_net_GBI_16_06_2023_NZTM_edges.shp"))

```

```{r Import AIS Downstream Network}
ais_down_nodes.sf <- st_read(file.path(inputs,
                                        "AIS_net_Caulerpa_30_06_2023_NZTM_nodes.shp"))
  
  
ais_down_edges.sf <- st_read(file.path(inputs,
                                        "AIS_net_Caulerpa_30_06_2023_NZTM_edges.shp"))

```


# Manipulate

```{r Transform to WGS84}
survey_reach_nodes_wgs84.sf <- st_transform(survey_reach_nodes.sf, crs = "EPSG:4326")
survey_reach_edges_wgs84.sf <- st_transform(survey_reach_edges.sf, crs = "EPSG:4326") 

survey_down_nodes_wgs84.sf <- st_transform(survey_down_nodes.sf, crs = "EPSG:4326")
survey_down_edges_wgs84.sf <- st_transform(survey_down_edges.sf, crs = "EPSG:4326")

ais_reach_nodes_wgs84.sf <- st_transform(ais_reach_nodes.sf, crs = "EPSG:4326")
ais_reach_edges_wgs84.sf <- st_transform(ais_reach_edges.sf, crs = "EPSG:4326")

ais_down_nodes_wgs84.sf <- st_transform(ais_down_nodes.sf, crs = "EPSG:4326")
ais_down_edges_wgs84.sf <- st_transform(ais_down_edges.sf, crs = "EPSG:4326")


```

Need to separate into Caulerpa nodes, northland nodes and nodes outside of northland

```{r Seperate Reacability Data}

survey_reach_nodes_wgs84_NRC.sf <- survey_reach_nodes_wgs84.sf %>%
                                                  filter(Region == "Northland Region")
survey_reach_nodes_wgs84_NRC_ANC.sf <- survey_reach_nodes_wgs84_NRC.sf %>%
                                                  filter(anchorg == "Yes")
survey_reach_nodes_wgs84_NRC_NOANC.sf <- survey_reach_nodes_wgs84_NRC.sf %>%
                                                  filter(anchorg == "No")

survey_reach_nodes_wgs84_REM.sf <- survey_reach_nodes_wgs84.sf %>%
                                                  filter(!Region == "Northland Region")

reach_nodes <- c("1108", "1130", "1131", "1132", "1625", "1287", "1395", "1571", "1572", "1288", "1390")

Node_leaflet_84_REM.sf2 <- filter(survey_reach_nodes_wgs84_REM.sf, !nID %in% reach_nodes)

# Caulerpa Reach Nodes
Node_leaflet_84_REM_REACH.sf <- filter(survey_reach_nodes_wgs84_REM.sf, nID %in% reach_nodes)

anchorage.df <- survey_reach_nodes_wgs84_NRC.sf %>%
                  dplyr::select(nID, anchorg) %>%
                  st_drop_geometry()

ais_reach_nodes_wgs84.sf <- st_transform(ais_reach_nodes.sf, crs = "EPSG:4326")
ais_reach_edges_wgs84.sf <- st_transform(ais_reach_edges.sf, crs = "EPSG:4326")

ais_reach_nodes_wgs84_NRC.sf <- ais_reach_nodes_wgs84.sf %>%
                                                  filter(Region == "Northland Region") %>%
                                                  merge(anchorage.df, by = "nID")


ais_reach_nodes_wgs84_NRC_ANC.sf <- ais_reach_nodes_wgs84_NRC.sf %>%
                                                  filter(anchorg == "Yes")
ais_reach_nodes_wgs84_NRC_NOANC.sf <- ais_reach_nodes_wgs84_NRC.sf %>%
                                                  filter(anchorg == "No")

ais_reach_nodes_wgs84_REM.sf <- ais_reach_nodes_wgs84.sf %>%
                                                  filter(!Region == "Northland Region")

reach_nodes <- c( # "1108", 
                 "1130", "1131", "1132", "1625", "1287", "1395", "1571", "1572", "1288", "1390")

ais_node_leaflet_84_REM.sf2 <- filter(ais_reach_nodes_wgs84_REM.sf, !nID %in% reach_nodes)

# Caulerpa Reach Nodes
ais_node_leaflet_84_REM_REACH.sf <- filter(ais_reach_nodes_wgs84_REM.sf, nID %in% reach_nodes)


```

```{r Seperate Downstream Data}
# Survey Downstream
  # Filter Northland Nodes
  survey_leaflet_84_5kn_NRC.sf <- survey_down_nodes_wgs84.sf %>%
                                                    filter(Region == "Northland Region")
  survey_leaflet_84_5kn_NRC.sf2 <- survey_leaflet_84_5kn_NRC.sf %>%
                                                    filter(!nID == "1116")
  survey_leaflet_84_5kn_NRC_OMA.sf <- survey_leaflet_84_5kn_NRC.sf %>%
                                                    filter(nID == "1116")
  survey_leaflet_84_5kn_NRC_ANC.sf <- survey_leaflet_84_5kn_NRC.sf2 %>%
                                                    filter(anchorg == "Yes")
  survey_leaflet_84_5kn_NRC_NOANC.sf <- survey_leaflet_84_5kn_NRC.sf2 %>%
                                                    filter(anchorg == "No")
  
  # Filter remaining surveys
  survey_leaflet_84_5kn_REM.sf <- survey_down_nodes_wgs84.sf %>%
                                                    filter(!Region == "Northland Region")
  
  # Filter infected nodes - excluding Omakiwi cove node
  infected_nodes <- c("1108", "1130", "1131",  "1116")
  # infected_nodes <- c("1130", "1131")
  survey_leaflet_84_5kn_REM.sf2 <- filter(survey_leaflet_84_5kn_REM.sf, !nID %in% infected_nodes)
  
  survey_leaflet_84_5kn_REM_INF.sf <- filter(survey_leaflet_84_5kn_REM.sf, nID %in% infected_nodes)
  
# AIS Downstream
  # Filter Northland Nodes
  ais_leaflet_84_5kn_NRC.sf <- ais_down_nodes_wgs84.sf %>%
                                                    filter(Region == "Northland Region") %>%
                                                    merge(anchorage.df, by = "nID")
  ais_leaflet_84_5kn_NRC.sf2 <- ais_leaflet_84_5kn_NRC.sf 
  
  ais_leaflet_84_5kn_NRC_ANC.sf <- ais_leaflet_84_5kn_NRC.sf2 %>%
                                                    filter(anchorg == "Yes")
  ais_leaflet_84_5kn_NRC_NOANC.sf <- ais_leaflet_84_5kn_NRC.sf2 %>%
                                                    filter(anchorg == "No")
  
  # Filter remaining surveys
  ais_leaflet_84_5kn_REM.sf <- ais_down_nodes_wgs84.sf %>%
                                                    filter(!Region == "Northland Region")
  
  # Filter infected nodes - excluding Omakiwi cove node
  infected_ais_nodes <- c("1130", "1131")

  ais_leaflet_84_5kn_REM.sf2 <- filter(ais_leaflet_84_5kn_REM.sf, !nID %in% infected_ais_nodes)
  
  ais_leaflet_84_5kn_REM_INF.sf <- filter(ais_leaflet_84_5kn_REM.sf, nID %in% infected_ais_nodes)
```


```{r Set Up Edge Symbology}
# Edges
  # Calculate breaks
  TWSA_breaks_edges <- c(0.00001, 0.02, 0.1, 0.25, 1, 100)
  # TWSA_breaks_edges <-  quantile(ais_reach_edges_wgs84.sf$Perc_total, probs = c(0, 0.2, 0.4, 0.75, 0.9, 1))

    # Create binned variable column
  ais_reach_edges_wgs84.sf$perc_bin <- cut(ais_reach_edges_wgs84.sf$Perc_total, breaks = TWSA_breaks_edges,
                                             labels = c("<0.02", "0.02 - 0.1", "0.1 - 0.25", "0.25 - 1", ">1"))
  survey_reach_edges_wgs84.sf$perc_bin <- cut(survey_reach_edges_wgs84.sf$Perc_tot, breaks = TWSA_breaks_edges,
                                              labels = c("<0.02", "0.02 - 0.1", "0.1 - 0.25", "0.25 - 1", ">1"))
  survey_down_edges_wgs84.sf$perc_bin <- cut(survey_down_edges_wgs84.sf$Perc_tot, breaks = TWSA_breaks_edges,
                                              labels = c("<0.02", "0.02 - 0.1", "0.1 - 0.25", "0.25 - 1", ">1"))
  
   ais_down_edges_wgs84.sf$perc_bin <- cut(ais_down_edges_wgs84.sf$Field, breaks = TWSA_breaks_edges,
                                              labels = c("<0.02", "0.02 - 0.1", "0.1 - 0.25", "0.25 - 1", ">1"))
  
  # Edges
  # Create color factor using the custom palette
  edge_palette  <- c("#E3E5DC", "#E7E8C4", "#E4DDBD", "#CBA66E", "#8E2D11")
  edge_pal      <- colorFactor(palette = edge_palette, ais_reach_edges_wgs84.sf$perc_bin)

  # Custom edge weights
  custom_weights <- c(0.5, 1, 2, 4, 6)
  edge_weights <- function(bin) {
    # Map vessel_bin values to custom_weights
    return(custom_weights[bin])
  }
```

```{r Set Up Node Symbology}
# # Create a custom color palette from dark to light blue
# vessel_palette  <- c("#10436D", "#006E9C", "#009DC5", "#00CDE7", "#00FFFF")
# # vessel_palette  <- c("#3a6d4d", "#006E9C", "#009DC5", "#00CDE7", "#00FFFF")
# 
# # Nodes
#   # Calculate quantiles for node_leaflet.sf$in_strength
#   TWSA_breaks_nodes <-  quantile(node_leaflet.sf$in_strength, probs = c(0, 0.2, 0.4, 0.6, 0.8, 1))
# 
#   
#   # Create binned variable column
#   node_leaflet_commercial.sf$TWSA_bin <- cut(node_leaflet_commercial.sf$in_strength, breaks = TWSA_breaks_nodes, labels = c("<83.8", "83.8 - 459.28", "459.29 - 1356.49", "1356.5 - 7261.2", ">7261.2"))
#   node_leaflet_recreational.sf$TWSA_bin <- cut(node_leaflet_recreational.sf$in_strength, breaks = TWSA_breaks_nodes, labels = c("<83.8", "83.8 - 459.28", "459.29 - 1356.49", "1356.5 - 7261.2", ">7261.2"))
#   node_leaflet_both.sf$TWSA_bin <- cut(node_leaflet_both.sf$in_strength, breaks = TWSA_breaks_nodes, labels = c("<83.8", "83.8 - 459.28", "459.29 - 1356.49", "1356.5 - 7261.2", ">7261.2"))
#   # if TWSA_bin is na, change it to <41.9
#   # node_leaflet_main.sf$TWSA_bin[is.na(node_leaflet_main.sf$TWSA_bin)] <- "<41.9" # figure out why NAs
#   
#   # View the modified dataframe
#   head(node_leaflet_commercial.sf)
# 
# # Nodes
#   # Create color factor using the custom palette
#   # node_pal      <- colorFactor(palette = vessel_palette, node_leaflet_main.sf$TWSA_bin)
#   
#   # Custom node sizes
#   custom_size <- c(2, 5, 7.5, 11, 15)
#   node_sizes <- function(bin) {
#     # Map strength_bin values to custom_size
#     return(custom_size[bin])
#   } 
#   


```





# Plot 


```{r Interactive Leaflet plot}
p_load(htmlwidgets)
p_load(htmltools)
# Add custom legend
downstream_legend <- HTML('
  <div style="background:white; padding:8px; border-radius:5px; font-size:12px; line-height:1.4;">
    <b>Relative <i>Caulerpa</i> Pressure</b><br>
    % of total region-wide anchoring events<br>
    <div><span style="display:inline-block; width:12px; height:12px; border-radius:50%; background:red; margin-right:6px;"></span>< 1</div>
    <div><span style="display:inline-block; width:16px; height:16px; border-radius:50%; background:red; margin-right:6px;"></span>1 - 2.5</div>
    <div><span style="display:inline-block; width:20px; height:20px; border-radius:50%; background:red; margin-right:6px;"></span>2.5 - 5</div>
    <div><span style="display:inline-block; width:24px; height:24px; border-radius:50%; background:red; margin-right:6px;"></span>> 5</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; background:blue; margin-right:6px;"></span>Exotic <i>Caulerpa</i> sites</div>
    <br>
    <b>Annual vessel movements</b><br>
    % of nationwide total<br>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #E3E5DC; margin-right:6px;"></span>< 0.02</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #E7E8C4; margin-right:6px;"></span>0.02 - 0.1</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #E4DDBD; margin-right:6px;"></span>0.1 - 0.25</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #CBA66E; margin-right:6px;"></span>0.25 - 2.5</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #8E2D11; margin-right:6px;"></span>> 2.5</div>
  </div>
')

reachability_legend <- HTML('
  <div style="background:white; padding:8px; border-radius:5px; font-size:12px; line-height:1.4;">
    <b>Annual vessel arrivals</b><br>
    % of nationwide total<br>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; border:1px solid black; background:white; margin-right:6px;"></span>< 0.25</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; border:1px solid black; background:white; margin-right:6px;"></span>0.25 - 1</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; border:1px solid black; background:white; margin-right:6px;"></span>1 - 2.5</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; border:1px solid black; background:white; margin-right:6px;"></span>> 2.5</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; background:red; margin-right:6px;"></span>NRC sites</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; background:blue; margin-right:6px;"></span>Exotic <i>Caulerpa</i> sites</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; background:lightgrey; margin-right:6px;"></span>Sites outside of NRC</div>
    <br>
    <b>Annual vessel movements</b><br>
    % of nationwide total<br>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #E3E5DC; margin-right:6px;"></span>< 0.02</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #E7E8C4; margin-right:6px;"></span>0.02 - 0.1</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #E4DDBD; margin-right:6px;"></span>0.1 - 0.25</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #CBA66E; margin-right:6px;"></span>0.25 - 1</div>
    <div><span style="display:inline-block; width:30px; border-top:4px solid #8E2D11; margin-right:6px;"></span>> 1</div>
  </div>
')

caulerpa_leaflet.plot <- leaflet() %>%
                        leaflet(options = leafletOptions(maxZoom = 13)) %>%
                        addProviderTiles(providers$OpenStreetMap.Mapnik, 
                                         group = "OSM Mapnik") %>%
                        # Survey Reachability
                        addPolylines(data = survey_reach_edges_wgs84.sf,
                                     color = ~edge_pal(perc_bin), 
                                     opacity = 1,
                                     weight = ~edge_weights(perc_bin),
                                     group = "Survey Reachability",
                                     label = ~ paste0("From", from, "To", to),
                                     popup = ~ paste0("From", from, "To", to, ", Vessels =", vessels)) %>%         
                        addCircleMarkers(data = Node_leaflet_84_REM.sf2,
                                         color = "gray",
                                         radius = 2,
                                         opacity = 1,
                                         group = "Survey Reachability",
                                         label = ~ paste0(name, ", ", Region),
                                         popup = ~ paste0(name, ", ", Region)
                                         ) %>%
                        addCircleMarkers(data = survey_reach_nodes_wgs84_NRC_NOANC.sf,
                                         color = "dimgray",
                                         fillColor = "dimgray",
                                         radius = 3,
                                         opacity = 1,
                                         fillOpacity = 1,
                                         group = "Survey Reachability",
                                         label = ~ paste0(name, ", ", Region),
                                         popup = ~ paste0(name, ", ID:", nID, ", ", Region)
                                         ) %>%
                        addCircleMarkers(data = survey_reach_nodes_wgs84_NRC_ANC.sf,
                                         color = "red",
                                         fillColor = "red",
                                         radius = 3,
                                         opacity = 1,
                                         fillOpacity = 1,
                                         group = "Survey Reachability",
                                         label = ~ paste0(name, ", ", Region),
                                         popup = ~ paste0(name, ", ID:", nID, ", ", Region)
                                         ) %>%
                        addCircleMarkers(data = Node_leaflet_84_REM_REACH.sf,
                                         color = "blue",
                                         fillColor = "blue",
                                         radius = 5,
                                         opacity = 1,
                                         fillOpacity = 1,
                                         group = "Survey Reachability",
                                         label = ~ paste0(name, ", ", Region),
                                         popup = ~ paste0(name, ", ID:", nID, ", ", Region)
                                         ) %>%
                        # AIS Reachability
                        addPolylines(data = ais_reach_edges_wgs84.sf,
                                     color = ~edge_pal(perc_bin),
                                     opacity = 1,
                                     weight = ~edge_weights(perc_bin),
                                     group = "AIS Reachability",
                                     label = ~ paste0("From ", from, " To ", to),
                                     popup = ~ paste0("From ", from, " To ", to, ", Vessels =", Noboats)) %>%         
                        addCircleMarkers(data = ais_node_leaflet_84_REM.sf2,
                                         color = "gray",
                                         radius = 2,
                                         opacity = 1,
                                         group = "AIS Reachability",
                                         label = ~ paste0(name, ", ", Region),
                                         popup = ~ paste0(name, ", ", Region)
                                         ) %>%
                        addCircleMarkers(data = ais_reach_nodes_wgs84_NRC_NOANC.sf,
                                         color = "dimgray",
                                         fillColor = "dimgray",
                                         radius = 3,
                                         opacity = 1,
                                         fillOpacity = 1,
                                         group = "AIS Reachability",
                                         label = ~ paste0(name, ", ", Region),
                                         popup = ~ paste0(name, ", ID:", nID, ", ", Region)
                                         ) %>%
                        addCircleMarkers(data = ais_reach_nodes_wgs84_NRC_ANC.sf,
                                         color = "red",
                                         fillColor = "red",
                                         radius = 3,
                                         opacity = 1,
                                         fillOpacity = 1,
                                         group = "AIS Reachability",
                                         label = ~ paste0(name, ", ", Region),
                                         popup = ~ paste0(name, ", ID:", nID, ", ", Region)
                                         ) %>%
                        addCircleMarkers(data = ais_node_leaflet_84_REM_REACH.sf,
                                         color = "blue",
                                         fillColor = "blue",
                                         radius = 5,
                                         opacity = 1,
                                         fillOpacity = 1,
                                         group = "AIS Reachability",
                                         label = ~ paste0(name, ", ", Region),
                                         popup = ~ paste0(name, ", ID:", nID, ", ", Region)
                                         ) %>%
                        # Survey Downstream
                        addPolylines(data = survey_down_edges_wgs84.sf, 
                                                   weight = ~edge_weights(perc_bin), 
                                                   color = ~edge_pal(perc_bin),
                                                   group = "Survey Downstream",
                                                    popup = ~ paste0("From", from, "To", to, ", Vessels = ", vessels)) %>% # adds edges
                        addCircleMarkers(data = survey_leaflet_84_5kn_REM.sf2,
                                         radius = 2,
                                         color = "dimgray",
                                         fillOpacity = 5,
                                         group = "Survey Downstream",
                                         popup = ~ paste0(name, ", ",  Type, ", ID:", nID, ", ", Region, ", Percentage of Incoming Vessels Nationwide: ", TON)) %>%    # Add non Northland nodes
                        addCircleMarkers(data = survey_leaflet_84_5kn_NRC_NOANC.sf,
                                         radius = 3,
                                         color = "dimgray",
                                         fillColor = "lightgray",
                                         fillOpacity = 5,
                                         group = "Survey Downstream",
                                         popup = ~ paste0(name,", ",  Type, ", ID:", nID, ", ", Region, ", Incoming Vessels = ", incmng_, ", Percentage of Incoming Vessels Nationwide: ", per_inc, "%")) %>%             # Add non-anchorage Northland nodes
                        addCircleMarkers(data = survey_leaflet_84_5kn_REM_INF.sf,
                                         radius = 12,
                                         color = "blue",
                                         fillColor = "blue",
                                         fillOpacity = 5,
                                         group = "Survey Downstream",
                                         popup = ~ paste0(name,", ",  Type, ", ID:", nID, ", ", Region)) %>% # Added infected nodes
                        addCircleMarkers(data = survey_leaflet_84_5kn_NRC_OMA.sf,
                                         radius = ~(sqrt(per_inc)) * 5,
                                         color = "blue",
                                         fillColor = "blue",
                                         fillOpacity = ~per_inc,
                                         group = "Survey Downstream",
                                         popup = ~ paste0(name,", ",  Type, ", ID:", nID, ", ", Region, ", Incoming Vessels = ", incmng_, ", Percentage of Incoming Vessels Nationwide: ", per_inc, "%")) %>% # adds Infected BOI node
                        addCircleMarkers(data = survey_leaflet_84_5kn_NRC_ANC.sf,
                                         radius = ~(sqrt(per_inc)) * 5,
                                         color = "red",
                                         fillColor = "red",
                                         fillOpacity = ~per_inc,
                                         group = "Survey Downstream",
                                         popup = ~ paste0(name,", ",  Type, ", ID:", nID, ", ", Region, ", Incoming Vessels = ", incmng_, ", Percentage of Incoming Vessels Nationwide: ", per_inc, "%")) %>% # adds northland anchoring nodes
                        # AIS Downstream
                        addPolylines(data = ais_down_edges_wgs84.sf, 
                                                   weight = ~edge_weights(perc_bin), 
                                                   color = ~edge_pal(perc_bin),
                                                   group = "AIS Downstream",
                                                    popup = ~ paste0("From", from, "To", to, ", Vessels = ", Noboats)) %>% # adds edges
                        addCircleMarkers(data = ais_leaflet_84_5kn_REM.sf2,
                                         radius = 2,
                                         color = "dimgray",
                                         fillOpacity = 5,
                                         group = "AIS Downstream",
                                         popup = ~ paste0(name, ", ",  Tr1_typ, ", ID:", nID, ", ", Region, ", Percentage of Incoming Vessels Nationwide: ", Perc_tot)) %>%    # Add non Northland nodes
                        addCircleMarkers(data = ais_leaflet_84_5kn_NRC_NOANC.sf,
                                         radius = 3,
                                         color = "dimgray",
                                         fillColor = "lightgray",
                                         fillOpacity = 5,
                                         group = "AIS Downstream",
                                         popup = ~ paste0(name,", ",  Tr1_typ, ", ID:", nID, ", ", Region, ", Incoming Vessels = ", in_strn, ", Percentage of Incoming Vessels Nationwide: ", Perc_tot, "%")) %>%             # Add non-anchorage Northland nodes
                        addCircleMarkers(data = ais_leaflet_84_5kn_REM_INF.sf,
                                         radius = 12,
                                         color = "blue",
                                         fillColor = "blue",
                                         fillOpacity = 5,
                                         group = "AIS Downstream",
                                         popup = ~ paste0(name,", ",  Tr1_typ, ", ID:", nID, ", ", Region)) %>% # Added infected nodes
                        addCircleMarkers(data = ais_leaflet_84_5kn_NRC_ANC.sf,
                                         radius = ~(sqrt(Perc_tot)) * 5,
                                         color = "red",
                                         fillColor = "red",
                                         fillOpacity = ~Perc_tot,
                                         group = "AIS Downstream",
                                         popup = ~ paste0(name,", ",  Tr1_typ, ", ID:", nID, ", ", Region, ", Incoming Vessels = ", in_strn, ", Percentage of Incoming Vessels Nationwide: ", Perc_tot, "%")) %>% # adds northland anchoring nodes              
                        # Set up map controls and options
                        setView(173.40, -42.22, zoom = 4) %>%
                        addControl(html = "<div id='map-title'>Author: Cal Faubel & Kyle Hilliam</div>",
                                          position = "bottomleft") %>%
                       addControl(html = "<div id='map-title' style='font-weight: bold;'>NZ Domestic Vessel Caulerpa Reach</div>", 
                           position = "topright") %>%
                        addScaleBar(position = "bottomright") %>%
                        hideGroup(c("Survey Downstream",
                                    "AIS Reachability",
                                    "AIS Downstream")) %>% # Hide all but first layer
                        addLayersControl(overlayGroups = c("Survey Reachability", 
                                                   "Survey Downstream",
                                                   "AIS Reachability",
                                                   "AIS Downstream"),
                                 options = layersControlOptions(collapsed = FALSE)) %>%
                        addEasyButton(easyButton(icon = "fa-globe",
                                                  title = "Reset View",
                                                  onClick = JS("function(btn, map){ map.setView([-42.22, 173.40], 4); }"))) %>%
                        # addLegendCustom(position = "bottomright",
                        #                 html = downstream_legend,
                        #                 group = c("AIS Downstream", "Survey Downstream")) %>%
                        # addLegendCustom(position = "bottomright",
                        #                 html = reachability_legend,
                        #                 group = c("AIS Reachability", "Survey Reachability")) %>%
                        addMiniMap(tiles = providers$OpenStreetMap.Mapnik,  # match the default main map base layer
                                    toggleDisplay = TRUE,
                                    minimized = TRUE,
                                    position = "topleft") # add inset map

# Inject custom legends with JS show/hide
caulerpa_leaflet.plot <- caulerpa_leaflet.plot %>%
  onRender("
    function(el, x) {
      // ---- Reachability Legend ----
      var reachLegend = L.control({position: 'bottomright'});
      reachLegend.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = '<b>Reachability Legend</b><br>' +
                        '<i style=\"background:red; width:12px; height:12px; display:inline-block;\"></i> NRC sites<br>' +
                        '<i style=\"background:blue; width:12px; height:12px; display:inline-block;\"></i> Exotic Caulerpa sites<br>' +
                        '<i style=\"background:lightgrey; width:12px; height:12px; display:inline-block;\"></i> Sites outside of NRC<br>';
        return div;
      };

      // ---- Downstream Legend ----
      var downLegend = L.control({position: 'bottomright'});
      downLegend.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = '<b>Downstream Legend</b><br>' +
                        '<i style=\"background:#ffffcc; width:20px; height:4px; display:inline-block;\"></i> <0.02<br>' +
                        '<i style=\"background:#ffeda0; width:20px; height:4px; display:inline-block;\"></i> 0.02–0.1<br>' +
                        '<i style=\"background:#feb24c; width:20px; height:4px; display:inline-block;\"></i> 0.1–0.25<br>' +
                        '<i style=\"background:#f03b20; width:20px; height:4px; display:inline-block;\"></i> 0.25–1<br>' +
                        '<i style=\"background:#bd0026; width:20px; height:4px; display:inline-block;\"></i> >1<br>';
        return div;
      };

      // ---- Show/hide legends depending on overlay groups ----
      this.on('overlayadd', function(e) {
        if (e.name == 'AIS Reachability' || e.name == 'Survey Reachability') {
          reachLegend.addTo(this);
        }
        if (e.name == 'AIS Downstream' || e.name == 'Survey Downstream') {
          downLegend.addTo(this);
        }
      });

      this.on('overlayremove', function(e) {
        if (e.name == 'AIS Reachability' || e.name == 'Survey Reachability') {
          this.removeControl(reachLegend);
        }
        if (e.name == 'AIS Downstream' || e.name == 'Survey Downstream') {
          this.removeControl(downLegend);
        }
      });
    }
  ")

caulerpa_leaflet.plot



```




