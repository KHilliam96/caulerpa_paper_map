---
title: "caulerpa_paper_map"
output: html_document
date: "2025-08-05"
editor_options: 
  chunk_output_type: console
---


Code developed using R version 4.5

Remote code repository location: https://github.com/KHilliam96/

# Aim
-   create interactive caulerpa map

# To Do
-   sort location and site names in metadata to merge 

# Important Notes
-   

# Labelling System

-   .df, .list, .dist etc at the end of an object signify what class it is
-   iterations of an object where no significant change has occured will be noted numerically i.e., .df/.df2/.df3
-   df with spatial information and sf or sp objects will contain the coordinate system in their name, e.g., buffer_WGS1984.sf once transformed. But will not in first instance (buffer.df)

# Setup

```{r setup, include = FALSE}
# https://bookdown.org/yihui/rmarkdown/r-code.html
knitr::opts_chunk$set(echo = FALSE, message = FALSE,
  warnings = FALSE, error = FALSE)

```

```{r packages, include = FALSE}
# Clear the space
rm(list = ls()) # clear memory

# Load packages
# Install and load pacman
if (!requireNamespace("pacman", quietly = TRUE)) {
  message("pacman is being installed and has been loaded.")
  install.packages("pacman")
  library(pacman)
} else {
  message("pacman is installed and has been loaded.")
  library(pacman)
}

# Data Wrangling
pacman::p_load(tidyverse)
pacman::p_load(igraph)

# Spatial
pacman::p_load(sf)
library(MSEaC)

# Plotting
pacman::p_load(leaflet)
pacman::p_load(leaflet.extras)
p_load(htmlwidgets)
p_load(htmltools)

```

```{r Set up versioning and outputs, include = FALSE}
options(scipen = 999)
write_outputs <- FALSE
version <- "_V1"

# project_directory <- "/home/khill/Documents/science/caulerpa_paper_2025"
project_directory <- "C:/Users/KyleHilliam/OneDrive - Sydney Institute of Marine Science/Documents/science/data/caulerpa_paper"

```

```{r File Locations, include = FALSE}
setwd(project_directory)
getwd()

# Get the location of our input data (this folder was created manually when
# saving the data)

inputs <- file.path(project_directory, "1_raw_inputs")

# All other folders can be created in the code (note, will only do this once)

# Create a directory to store current work in progress and files created in R

wip_r_directory <- file.path(project_directory, "2_wip_r")

if (!"work_in_progress_R" %in% basename(list.dirs(project_directory))) { # Check folder has not already been created
  
  dir.create(wip_r_directory)
  
  print("creating directory to store wip files")
  
} else {
  
  print("found existing wip directory")
  
}

# Create a directory to store current work in progress and files created in GIS

wip_gis_directory <- file.path(project_directory, "3_wip_non_code")

if (!"work_in_progress_GIS" %in% basename(list.dirs(project_directory))) { # Check folder has not already been created
  
  dir.create(wip_gis_directory)
  
  print("creating directory to store GIS wip files")
  
} else {
  
  print("found existing non-code wip directory")
  
}

# Create a directory to store all finalised outputs

processed_output_directory <- file.path(project_directory, "4_clean_outputs")

if (!"processed_outputs" %in% basename(list.dirs(project_directory))) { # Check folder has not already been created
  
  dir.create(processed_output_directory)
  
  print("creating directory to store outputs")
  
} else {
  
  print("found existing outputs directory")
  
}

# Create a directory to store all finalised figures

figure_directory <- file.path(project_directory, "5_manuscript_figures")

if (!"5_manuscript_figures" %in% basename(list.dirs(project_directory))) { # Check folder has not already been created
  
  dir.create(figure_directory)
  
  print("creating directory to store figures")
  
} else {
  
  print("found existing figure directory")
  
  
}  

# Create a directory to store all supplementary figures

supporting_directory <- file.path(project_directory, "6_supporting_figures")

if (!"6_supporting_figures" %in% basename(list.dirs(project_directory))) { # Check folder has not already been created
  
  dir.create(supporting_directory)
  
  print("creating directory to store figures")
  
} else {
  
  print("found existing supporting directory")
  
  
}
  
```

# Import data

```{r Import Survey Reachability Network}
survey_reach_nodes.sf <- st_read(file.path(inputs, 
                                           "rec_net_caulerpa_V4.0_nodes.shp"))
  
survey_reach_edges.sf <- st_read(file.path(inputs, 
                                          "rec_net_caulerpa_V4.0_edges.shp"))

```

```{r Import Survey Downstream Network}
survey_down_nodes.sf <- st_read(file.path(inputs, 
                                         "rec_net_caulerpa_downstream_5kn_V4.0_nodes.shp"))

survey_down_edges.sf <- st_read(file.path(inputs,
                                          "rec_net_caulerpa_downstream_5kn_V4.0_edges.shp"))

```

```{r Import AIS Reachability Network}
ais_reach_nodes.sf <- st_read(file.path(inputs,
                                        "AIS_net_GBI_16_06_2023_NZTM_nodes.shp"))

ais_reach_edges.sf <- st_read(file.path(inputs,
                                        "AIS_net_GBI_16_06_2023_NZTM_edges.shp"))

```

```{r Import AIS Downstream Network}
ais_down_nodes.sf <- st_read(file.path(inputs,
                                        "AIS_net_Caulerpa_30_06_2023_NZTM_nodes.shp"))


ais_down_edges.sf <- st_read(file.path(inputs,
                                        "AIS_net_Caulerpa_30_06_2023_NZTM_edges.shp"))

```

```{r Import AIS reachability network}
# load rds file
ais_reach.net <- readRDS(file.path(inputs,
                                        "Reachability_AIS_network.rds"))

summary(ais_reach.net)
```


```{r Import AIS Downstream node fix}
ais_down_fix.df <- st_read(file.path(inputs,
                                        "AIS_Down_caulerpa_NRC_Oct25.shp")) %>%
                        dplyr::select(nID, name, Perc_tot) %>%
                        st_drop_geometry()
```



```{r Import common names}
common_names.df <- read.csv("S:/RDS28221-BiosecurityToolbox (eSolutions Admin)/individualProjects/CaulerpaKyle/Data/2_codeWIP/Kyle/Northland_node_common_names.csv") %>%
                            distinct()
```


# Manipulate

```{r Transform to WGS84}
survey_reach_nodes_wgs84.sf <- st_transform(survey_reach_nodes.sf, crs = "EPSG:4326")
survey_reach_edges_wgs84.sf <- st_transform(survey_reach_edges.sf, crs = "EPSG:4326") 

survey_down_nodes_wgs84.sf <- st_transform(survey_down_nodes.sf, crs = "EPSG:4326")
survey_down_edges_wgs84.sf <- st_transform(survey_down_edges.sf, crs = "EPSG:4326")

ais_reach_nodes_wgs84.sf <- st_transform(ais_reach_nodes.sf, crs = "EPSG:4326")
ais_reach_edges_wgs84.sf <- st_transform(ais_reach_edges.sf, crs = "EPSG:4326")

ais_down_nodes_wgs84.sf <- st_transform(ais_down_nodes.sf, crs = "EPSG:4326")
ais_down_edges_wgs84.sf <- st_transform(ais_down_edges.sf, crs = "EPSG:4326")

ais_reach_edges.sf <- igraph2sf_edge(ais_reach.net, 
                                     proj4 = "+proj=tmerc +lat_0=0 +lon_0=173 +k=0.9996 +x_0=1600000 +y_0=10000000 +datum=WGS84 +units=m +no_defs",
                                     dateline = TRUE)
plot(ais_reach_edges.sf$geometry)


# ais_reach_edges_wgs84.df <- ais_reach_edges_wgs84.sf %>%
#                                 st_drop_geometry() %>%
#                                 dplyr::select(from, to, No_boats)

# paste out x and y from ais_reach_nodes_wgs84.sf
ais_reach_nodes_wgs84.sf <- ais_reach_nodes_wgs84.sf %>%
                                mutate(lon = st_coordinates(geometry)[,1],
                                       lat = st_coordinates(geometry)[,2]) %>%
                                st_drop_geometry() %>%
                                mutate(lon = ifelse(lon < 0, lon + 360, lon)) %>%
                                st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = FALSE) 
  
  
                          

ais_reach_edges_wgs84.sf <- ais_reach_edges.sf # %>%
                            # merge(ais_reach_edges_wgs84.df, by = c("from", "to"), all.x = TRUE) 
  
```

```{r Merge in commons names}
common_names.df2 <- common_names.df %>%
                        dplyr::select(-nID) %>%
                        mutate(Common_name = gsub("Outer Bay of Islands' Moorings", "Te Rawhiti Inlet", Common_name)) # Change name to te rawhiti inlet

survey_reach_nodes_wgs84.sf2 <- survey_reach_nodes_wgs84.sf %>%
                                        merge(common_names.df2, by = "name", all.x = TRUE) %>%
                                        mutate(Cmmn_nm = coalesce(Common_name, name)) 

survey_down_nodes_wgs84.sf2 <- survey_down_nodes_wgs84.sf %>%
                                        merge(common_names.df2, by = "name", all.x = TRUE) %>%
                                        mutate(Cmmn_nm = coalesce(Common_name, name))

ais_reach_nodes_wgs84.sf2 <- ais_reach_nodes_wgs84.sf %>%
                                        merge(common_names.df2, by = "name", all.x = TRUE) %>%
                                        mutate(Cmmn_nm = coalesce(Common_name, name)) 

ais_down_nodes_wgs84.sf2 <- ais_down_nodes_wgs84.sf %>%
                                        merge(common_names.df2, by = "name", all.x = TRUE) %>%
                                        mutate(Cmmn_nm = coalesce(Common_name, name)) %>%
                                        merge(ais_down_fix.df, by = c("nID", "name"), all.x = TRUE) %>%
                                        mutate(Perc_tot = coalesce(Perc_tot.y, Perc_tot.x)) %>%
                                        dplyr::select(-c(Perc_tot.x, Perc_tot.y))
  

survey_reach_edges_wgs84.sf <- survey_reach_edges_wgs84.sf %>%
                                        merge(common_names.df2, by.x = "from", by.y = "name", all.x = TRUE) %>%
                                        rename(From_Cmmn_nm = Common_name) %>%
                                        mutate(From_Cmmn_nm = coalesce(From_Cmmn_nm, from)) %>%
                                        merge(common_names.df2, by.x = "to", by.y = "name", all.x = TRUE) %>%
                                        rename(To_Cmmn_nm = Common_name) %>%
                                        mutate(To_Cmmn_nm = coalesce(To_Cmmn_nm, to))

survey_down_edges_wgs84.sf <- survey_down_edges_wgs84.sf %>%
                                        merge(common_names.df2, by.x = "from", by.y = "name", all.x = TRUE) %>%
                                        rename(From_Cmmn_nm = Common_name) %>%
                                        mutate(From_Cmmn_nm = coalesce(From_Cmmn_nm, from)) %>%
                                        merge(common_names.df2, by.x = "to", by.y = "name", all.x = TRUE) %>%
                                        rename(To_Cmmn_nm = Common_name) %>%
                                        mutate(To_Cmmn_nm = coalesce(To_Cmmn_nm, to))

ais_reach_edges_wgs84.sf <- ais_reach_edges_wgs84.sf %>%
                                        merge(common_names.df2, by.x = "from", by.y = "name", all.x = TRUE) %>%
                                        rename(From_Cmmn_nm = Common_name) %>%
                                        mutate(From_Cmmn_nm = coalesce(From_Cmmn_nm, from)) %>%
                                        merge(common_names.df2, by.x = "to", by.y = "name", all.x = TRUE) %>%
                                        rename(To_Cmmn_nm = Common_name) %>%
                                        mutate(To_Cmmn_nm = coalesce(To_Cmmn_nm, to))

ais_down_edges_wgs84.sf <- ais_down_edges_wgs84.sf %>%
                                        merge(common_names.df2, by.x = "from", by.y = "name", all.x = TRUE) %>%
                                        rename(From_Cmmn_nm = Common_name) %>%
                                        mutate(From_Cmmn_nm = coalesce(From_Cmmn_nm, from)) %>%
                                        merge(common_names.df2, by.x = "to", by.y = "name", all.x = TRUE) %>%
                                        rename(To_Cmmn_nm = Common_name) %>%
                                        mutate(To_Cmmn_nm = coalesce(To_Cmmn_nm, to))
```

Need to separate into Caulerpa nodes, northland nodes and nodes outside of northland

```{r Seperate Reacability Data}

survey_reach_nodes_wgs84_NRC.sf <- survey_reach_nodes_wgs84.sf2 %>%
                                                  filter(Region == "Northland Region")
survey_reach_nodes_wgs84_NRC_ANC.sf <- survey_reach_nodes_wgs84_NRC.sf %>%
                                                  filter(anchorg == "Yes")
survey_reach_nodes_wgs84_NRC_NOANC.sf <- survey_reach_nodes_wgs84_NRC.sf %>%
                                                  filter(anchorg == "No")

survey_reach_nodes_wgs84_REM.sf <- survey_reach_nodes_wgs84.sf2 %>%
                                                  filter(!Region == "Northland Region")

reach_nodes <- c("1108", "1130", "1131", "1132", "1625", "1287", "1395", "1571", "1572", "1288", "1390")

Node_leaflet_84_REM.sf2 <- filter(survey_reach_nodes_wgs84_REM.sf, !nID %in% reach_nodes)

# Caulerpa Reach Nodes
Node_leaflet_84_REM_REACH.sf <- filter(survey_reach_nodes_wgs84_REM.sf, nID %in% reach_nodes)

anchorage.df <- survey_reach_nodes_wgs84_NRC.sf %>%
                  dplyr::select(nID, anchorg) %>%
                  st_drop_geometry()

# ais_reach_nodes_wgs84.sf <- st_transform(ais_reach_nodes.sf, crs = "EPSG:4326")
# ais_reach_edges_wgs84.sf <- st_transform(ais_reach_edges.sf, crs = "EPSG:4326")

ais_reach_nodes_wgs84_NRC.sf <- ais_reach_nodes_wgs84.sf2 %>%
                                                  filter(Region == "Northland Region") %>%
                                                  merge(anchorage.df, by = "nID")


ais_reach_nodes_wgs84_NRC_ANC.sf <- ais_reach_nodes_wgs84_NRC.sf %>%
                                                  filter(anchorg == "Yes")
ais_reach_nodes_wgs84_NRC_NOANC.sf <- ais_reach_nodes_wgs84_NRC.sf %>%
                                                  filter(anchorg == "No")

ais_reach_nodes_wgs84_REM.sf <- ais_reach_nodes_wgs84.sf2 %>%
                                                  filter(!Region == "Northland Region")

reach_nodes <- c( # "1108", 
                 "1130", "1131", "1132", "1625", "1287", "1395", "1571", "1572", "1288", "1390")

ais_node_leaflet_84_REM.sf2 <- filter(ais_reach_nodes_wgs84_REM.sf, !nID %in% reach_nodes)

# Caulerpa Reach Nodes
ais_node_leaflet_84_REM_REACH.sf <- filter(ais_reach_nodes_wgs84_REM.sf, nID %in% reach_nodes)


```

```{r Seperate Downstream Data}
# Survey Downstream
  # Filter Northland Nodes
  survey_leaflet_84_5kn_NRC.sf <- survey_down_nodes_wgs84.sf2 %>%
                                                    filter(Region == "Northland Region")
  survey_leaflet_84_5kn_NRC.sf2 <- survey_leaflet_84_5kn_NRC.sf %>%
                                                    filter(!nID == "1116")
  survey_leaflet_84_5kn_NRC_OMA.sf <- survey_leaflet_84_5kn_NRC.sf %>%
                                                    filter(nID == "1116")
  survey_leaflet_84_5kn_NRC_ANC.sf <- survey_leaflet_84_5kn_NRC.sf2 %>%
                                                    filter(anchorg == "Yes")
  survey_leaflet_84_5kn_NRC_NOANC.sf <- survey_leaflet_84_5kn_NRC.sf2 %>%
                                                    filter(anchorg == "No")
  
  # Filter remaining surveys
  survey_leaflet_84_5kn_REM.sf <- survey_down_nodes_wgs84.sf2 %>%
                                                    filter(!Region == "Northland Region")
  
  # Filter infected nodes - excluding Omakiwi cove node
  infected_nodes <- c("1108", "1130", "1131",  "1116")
  # infected_nodes <- c("1130", "1131")
  survey_leaflet_84_5kn_REM.sf2 <- filter(survey_leaflet_84_5kn_REM.sf, !nID %in% infected_nodes)
  
  survey_leaflet_84_5kn_REM_INF.sf <- filter(survey_leaflet_84_5kn_REM.sf, nID %in% infected_nodes)
  
# AIS Downstream
  # Filter Northland Nodes
  ais_leaflet_84_5kn_NRC.sf <- ais_down_nodes_wgs84.sf2 %>%
                                                    filter(Region == "Northland Region") %>%
                                                    merge(anchorage.df, by = "nID")
  ais_leaflet_84_5kn_NRC.sf2 <- ais_leaflet_84_5kn_NRC.sf 
  
  ais_leaflet_84_5kn_NRC_ANC.sf <- ais_leaflet_84_5kn_NRC.sf2 %>%
                                                    filter(anchorg == "Yes") # %>%
                                                    # mutate(sum_vessels = sum(in_strn, na.rm = TRUE),
                                                    #        Perc_tot = (in_strn/sum_vessels) * 100) %>%
                                                    # distinct()
  
  
  
  ais_leaflet_84_5kn_NRC_NOANC.sf <- ais_leaflet_84_5kn_NRC.sf2 %>%
                                                    filter(anchorg == "No")
  
  # Filter remaining surveys
  ais_leaflet_84_5kn_REM.sf <- ais_down_nodes_wgs84.sf2 %>%
                                                    filter(!Region == "Northland Region")
  
  # Filter infected nodes - excluding Omakiwi cove node
  infected_ais_nodes <- c("1130", "1131")

  ais_leaflet_84_5kn_REM.sf2 <- filter(ais_leaflet_84_5kn_REM.sf, !nID %in% infected_ais_nodes)
  
  ais_leaflet_84_5kn_REM_INF.sf <- filter(ais_leaflet_84_5kn_REM.sf, nID %in% infected_ais_nodes)
```

```{r Set up reachability and downstream symbology for nodes}
annual_vessel_breaks <- c(0.00001, 0.25, 1, 2.5, 100)
  # TWSA_breaks_edges <-  quantile(ais_reach_edges_wgs84.sf$Perc_total, probs = c(0, 0.2, 0.4, 0.75, 0.9, 1))

    # Create binned variable column
  survey_reach_nodes_wgs84_NRC_ANC.sf$perc_bin <- cut(survey_reach_nodes_wgs84_NRC_ANC.sf$Per_total, breaks = annual_vessel_breaks,
                                                      labels = c("<0.25", "0.25 - 1", "1 - 2.5", ">2.5"))
  Node_leaflet_84_REM.sf2$perc_bin <- cut(Node_leaflet_84_REM.sf2$Per_total, breaks = annual_vessel_breaks,
                                                      labels = c("<0.25", "0.25 - 1", "1 - 2.5", ">2.5"))
  
  
  ais_reach_nodes_wgs84_NRC_ANC.sf$perc_bin <- cut(ais_reach_nodes_wgs84_NRC_ANC.sf$Perc_tot, breaks = annual_vessel_breaks,
                                              labels = c("<0.25", "0.25 - 1", "1 - 2.5", ">2.5"))
  ais_node_leaflet_84_REM.sf2$perc_bin <- cut(ais_node_leaflet_84_REM.sf2$Perc_tot, breaks = annual_vessel_breaks,
                                              labels = c("<0.25", "0.25 - 1", "1 - 2.5", ">2.5"))
  
  
  node_custom_weights <- c(12, 16, 20, 24)

  reach_node_sizes <- function(bin) {
    # Map vessel_bin values to node_custom_weights
    return(node_custom_weights[bin])
  }
  
  
  down_vessel_breaks <- c(0.00001, 1, 2.5, 5, 100)

  # Create binned variable column
  survey_leaflet_84_5kn_NRC_ANC.sf$perc_bin <- cut(survey_leaflet_84_5kn_NRC_ANC.sf$per_inc, breaks = down_vessel_breaks,
                                                      labels = c("<1", "1 - 2.5", "2.5 - 5", ">5"))
  
  survey_leaflet_84_5kn_NRC_OMA.sf$perc_bin <- cut(survey_leaflet_84_5kn_NRC_OMA.sf$per_inc, breaks = down_vessel_breaks,
                                                      labels = c("<1", "1 - 2.5", "2.5 - 5", ">5"))
  
  
  ais_leaflet_84_5kn_NRC_ANC.sf$perc_bin <- cut(ais_leaflet_84_5kn_NRC_ANC.sf$Perc_tot, breaks = down_vessel_breaks,
                                                    labels = c("<1", "1 - 2.5", "2.5 - 5", ">5"))
  
  node_custom_weights <- c(12, 16, 20, 24)

  down_node_sizes <- function(bin) {
    # Map vessel_bin values to node_custom_weights
    return(node_custom_weights[bin])
  }

```


```{r Set Up Edge Symbology}
# Edges
  # Calculate breaks
  TWSA_breaks_edges <- c(0.00001, 0.02, 0.1, 0.25, 1, 100)
  # TWSA_breaks_edges <-  quantile(ais_reach_edges_wgs84.sf$Perc_total, probs = c(0, 0.2, 0.4, 0.75, 0.9, 1))

    # Create binned variable column
  ais_reach_edges_wgs84.sf$perc_bin <- cut(ais_reach_edges_wgs84.sf$Perc_tot, breaks = TWSA_breaks_edges,
                                             labels = c("<0.02", "0.02 - 0.1", "0.1 - 0.25", "0.25 - 1", ">1"))

  
  survey_reach_edges_wgs84.sf$perc_bin <- cut(survey_reach_edges_wgs84.sf$Perc_tot, breaks = TWSA_breaks_edges,
                                              labels = c("<0.02", "0.02 - 0.1", "0.1 - 0.25", "0.25 - 1", ">1"))
  
  
  
  # Custom edge weights
  # custom_weights <- c(0.5, 1, 2, 4, 6)
    custom_weights <- c(0.5, 1, 2, 4, 6)

  reach_edge_weights <- function(bin) {
    # Map vessel_bin values to custom_weights
    return(custom_weights[bin])
  }
  
  # Downstream 
  TWSA_down_breaks_edges <- c(0.00001, 0.02, 0.1, 0.25, 2.5, 100)

  survey_down_edges_wgs84.sf$perc_bin <- cut(survey_down_edges_wgs84.sf$Perc_tot, breaks = TWSA_down_breaks_edges,
                                              labels = c("<0.02", "0.02 - 0.1", "0.1 - 0.25", "0.25 - 2.5", ">2.5"))
  
   ais_down_edges_wgs84.sf$perc_bin <- cut(ais_down_edges_wgs84.sf$Field, breaks = TWSA_down_breaks_edges,
                                              labels = c("<0.02", "0.02 - 0.1", "0.1 - 0.25", "0.25 - 2.5", ">2.5"))
   
   # Custom edge weights
  # custom_weights <- c(0.5, 1, 2, 4, 6)
    custom_weights <- c(0.5, 1, 2, 4, 6)

  down_edge_weights <- function(bin) {
    # Map vessel_bin values to custom_weights
    return(custom_weights[bin])
  }
  
  # Edges
  # Create color factor using the custom palette
  edge_palette  <- c("#DFC9A1", "#FFE295", "#F1CA78", "#E7A244", "#873300")
  reach_edge_pal <- colorFactor(palette = edge_palette, ais_reach_edges_wgs84.sf$perc_bin)
  down_edge_pal <- colorFactor(palette = edge_palette, ais_down_edges_wgs84.sf$perc_bin)

  
```

```{r Set Up Node Symbology}
# # Create a custom color palette from dark to light blue
# vessel_palette  <- c("#10436D", "#006E9C", "#009DC5", "#00CDE7", "#00FFFF")
# # vessel_palette  <- c("#3a6d4d", "#006E9C", "#009DC5", "#00CDE7", "#00FFFF")
# 
# # Nodes
#   # Calculate quantiles for node_leaflet.sf$in_strength
#   TWSA_breaks_nodes <-  quantile(node_leaflet.sf$in_strength, probs = c(0, 0.2, 0.4, 0.6, 0.8, 1))
# 
#   
#   # Create binned variable column
#   node_leaflet_commercial.sf$TWSA_bin <- cut(node_leaflet_commercial.sf$in_strength, breaks = TWSA_breaks_nodes, labels = c("<83.8", "83.8 - 459.28", "459.29 - 1356.49", "1356.5 - 7261.2", ">7261.2"))
#   node_leaflet_recreational.sf$TWSA_bin <- cut(node_leaflet_recreational.sf$in_strength, breaks = TWSA_breaks_nodes, labels = c("<83.8", "83.8 - 459.28", "459.29 - 1356.49", "1356.5 - 7261.2", ">7261.2"))
#   node_leaflet_both.sf$TWSA_bin <- cut(node_leaflet_both.sf$in_strength, breaks = TWSA_breaks_nodes, labels = c("<83.8", "83.8 - 459.28", "459.29 - 1356.49", "1356.5 - 7261.2", ">7261.2"))
#   # if TWSA_bin is na, change it to <41.9
#   # node_leaflet_main.sf$TWSA_bin[is.na(node_leaflet_main.sf$TWSA_bin)] <- "<41.9" # figure out why NAs
#   
#   # View the modified dataframe
#   head(node_leaflet_commercial.sf)
# 
# # Nodes
#   # Create color factor using the custom palette
#   # node_pal      <- colorFactor(palette = vessel_palette, node_leaflet_main.sf$TWSA_bin)
#   
#   # Custom node sizes
#   custom_size <- c(2, 5, 7.5, 11, 15)
#   node_sizes <- function(bin) {
#     # Map strength_bin values to custom_size
#     return(custom_size[bin])
#   } 
#   


```





# Plot 


```{r Interactive Leaflet plot}
# Add custom legends
# ---- 1. Survey Reachability ----
survey_reachability_legend <- HTML('
  <div style="background:white; padding:8px; border-radius:5px; font-size:12px; line-height:1.4;">
    <b>Survey Reachability</b><br>
    11,322 Recreational Vessels (100%)<br><br>
    <b>Annual vessel arrivals</b><br>
    % of nationwide total<br>
    <div><span style="display:inline-block; width:12px; height:12px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>< 0.25</div>
    <div><span style="display:inline-block; width:16px; height:16px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>0.25 - 1</div>
    <div><span style="display:inline-block; width:20px; height:20px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>1 - 2.5</div>
    <div><span style="display:inline-block; width:24px; height:24px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>> 2.5</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; background:#0070FF; border:1.5px solid black; margin-right:6px;"></span>Exotic <em>Caulerpa</em> sites</div>
    <br>
    <b>Annual vessel movements</b><br>
    % of nationwide total<br>
    <div><span style="display:inline-block; width:30px; border-top:0.5px solid #DFC9A1; margin-right:6px;"></span>< 0.02</div>
    <div><span style="display:inline-block; width:30px; border-top:1px solid #FFE295; margin-right:6px;"></span>0.02 - 0.1</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #F1CA78; margin-right:6px;"></span>0.1 - 0.25</div>
    <div><span style="display:inline-block; width:30px; border-top:4px solid #E7A244; margin-right:6px;"></span>0.25 - 1</div>
    <div><span style="display:inline-block; width:30px; border-top:6px solid #873300; margin-right:6px;"></span>> 1</div>
  </div>
')

# ---- 2. AIS Reachability ----
ais_reachability_legend <- HTML('
  <div style="background:white; padding:8px; border-radius:5px; font-size:12px; line-height:1.4;">
    <b>AIS Reachability</b><br>
    405 Recreational Vessels (89%)<br>
    & 49 Commercial Vessels (11%)<br><br>
    <b>Annual vessel arrivals</b><br>
    % of nationwide total<br>
    <div><span style="display:inline-block; width:12px; height:12px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>< 0.25</div>
    <div><span style="display:inline-block; width:16px; height:16px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>0.25 - 1</div>
    <div><span style="display:inline-block; width:20px; height:20px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>1 - 2.5</div>
    <div><span style="display:inline-block; width:24px; height:24px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>> 2.5</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; background:#0070FF; border:1.5px solid black; margin-right:6px;"></span>Exotic <em>Caulerpa</em> sites</div>
    <br>
    <b>Annual vessel movements</b><br>
    % of nationwide total<br>
    <div><span style="display:inline-block; width:30px; border-top:0.5px solid #DFC9A1; margin-right:6px;"></span>< 0.02</div>
    <div><span style="display:inline-block; width:30px; border-top:1px solid #FFE295; margin-right:6px;"></span>0.02 - 0.1</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #F1CA78; margin-right:6px;"></span>0.1 - 0.25</div>
    <div><span style="display:inline-block; width:30px; border-top:4px solid #E7A244; margin-right:6px;"></span>0.25 - 1</div>
    <div><span style="display:inline-block; width:30px; border-top:6px solid #873300; margin-right:6px;"></span>> 1</div>
  </div>
')

# ---- 3. Survey Downstream ----
survey_downstream_legend <- HTML('
  <div style="background:white; padding:8px; border-radius:5px; font-size:12px; line-height:1.4;">
    <b>Survey Downstream</b><br>
    6,683 Recreational Vessels (100%)<br><br>
    <b>Relative <em>Caulerpa</em> Pressure</b><br>
    % of total region-wide anchoring events<br>
    <div><span style="display:inline-block; width:12px; height:12px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>< 1</div>
    <div><span style="display:inline-block; width:16px; height:16px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>1 - 2.5</div>
    <div><span style="display:inline-block; width:20px; height:20px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>2.5 - 5</div>
    <div><span style="display:inline-block; width:24px; height:24px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>> 5</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; background:#0070FF; border:1.5px solid black; margin-right:6px;"></span>Exotic <em>Caulerpa</em> sites</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; background:#9C9C9C; margin-right:6px;"></span>Sites outside of NRC</div>
    <br>
    <b>Annual vessel movements</b><br>
    % of nationwide total<br>
    <div><span style="display:inline-block; width:30px; border-top:0.5px solid #DFC9A1; margin-right:6px;"></span>< 0.02</div>
    <div><span style="display:inline-block; width:30px; border-top:1px solid #FFE295; margin-right:6px;"></span>0.02 - 0.1</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #F1CA78; margin-right:6px;"></span>0.1 - 0.25</div>
    <div><span style="display:inline-block; width:30px; border-top:4px solid #E7A244; margin-right:6px;"></span>0.25 - 2.5</div>
    <div><span style="display:inline-block; width:30px; border-top:6px solid #873300; margin-right:6px;"></span>> 2.5</div>
  </div>
')

# ---- 4. AIS Downstream ----
ais_downstream_legend <- HTML('
  <div style="background:white; padding:8px; border-radius:5px; font-size:12px; line-height:1.4;">
    <b>AIS Downstream</b><br>
    258 Recreational Vessels (89%)<br>
    & 33 Commercial Vessels (11%)<br><br>
    <b>Relative <em>Caulerpa</em> Pressure</b><br>
    % of total region-wide anchoring events<br>
    <div><span style="display:inline-block; width:12px; height:12px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>< 1</div>
    <div><span style="display:inline-block; width:16px; height:16px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>1 - 2.5</div>
    <div><span style="display:inline-block; width:20px; height:20px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>2.5 - 5</div>
    <div><span style="display:inline-block; width:24px; height:24px; border-radius:50%; background:red; border:1.5px solid black; margin-right:6px;"></span>> 5</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; background:#0070FF; border:1.5px solid black; margin-right:6px;"></span>Exotic <em>Caulerpa</em> sites</div>
    <div><span style="display:inline-block; width:14px; height:14px; border-radius:50%; background:#9C9C9C; margin-right:6px;"></span>Sites outside of NRC</div>
    <br>
    <b>Annual vessel movements</b><br>
    % of nationwide total<br>
    <div><span style="display:inline-block; width:30px; border-top:0.5px solid #DFC9A1; margin-right:6px;"></span>< 0.02</div>
    <div><span style="display:inline-block; width:30px; border-top:1px solid #FFE295; margin-right:6px;"></span>0.02 - 0.1</div>
    <div><span style="display:inline-block; width:30px; border-top:2px solid #F1CA78; margin-right:6px;"></span>0.1 - 0.25</div>
    <div><span style="display:inline-block; width:30px; border-top:4px solid #E7A244; margin-right:6px;"></span>0.25 - 2.5</div>
    <div><span style="display:inline-block; width:30px; border-top:6px solid #873300; margin-right:6px;"></span>> 2.5</div>
  </div>
')





caulerpa_leaflet.plot <- leaflet() %>%
                        leaflet(options = leafletOptions(maxZoom = 13)) %>%
                        addProviderTiles(providers$OpenStreetMap.Mapnik, 
                                         group = "OSM Mapnik") %>%
                        # Set up map controls and options
                        setView(173.40, -37.5, zoom = 6) %>%
                        addControl(html = "<div id='map-title'>Author: Cal Faubel & Kyle Hilliam</div>",
                                          position = "bottomleft") %>%
                        addControl(html = "<div id='map-title' style='font-weight: bold;'>NZ Domestic Vessel Exotic <em>Caulerpa</em> Reach</div>", 
                           position = "topright") %>%
                        addScaleBar(position = "bottomright") %>%
                        hideGroup(c("Survey Downstream",
                                    "AIS Reachability",
                                    "AIS Downstream")) %>% # Hide all but first layer
                        addLayersControl(baseGroups = c("Survey Reachability", 
                                                   "Survey Downstream",
                                                   "AIS Reachability",
                                                   "AIS Downstream"),
                                 options = layersControlOptions(collapsed = FALSE),
                                ) %>%
                        addEasyButton(easyButton(icon = "fa-globe",
                                                  title = "Reset View",
                                                  onClick = JS("function(btn, map){ map.setView([-37.5, 173.40], 6); }"))) %>%
                        # addLegendCustom(position = "bottomright",
                        #                 html = downstream_legend,
                        #                 group = c("AIS Downstream", "Survey Downstream")) %>%
                        # addLegendCustom(position = "bottomright",
                        #                 html = reachability_legend,
                        #                 group = c("AIS Reachability", "Survey Reachability")) %>%
                        addMiniMap(tiles = providers$OpenStreetMap.Mapnik,  # match the default main map base layer
                                    toggleDisplay = TRUE,
                                    minimized = TRUE,
                                    position = "topleft") # add inset map
                        



# split 
ais_reach_edges_wgs84.list    <- split(ais_reach_edges_wgs84.sf, ais_reach_edges_wgs84.sf$perc_bin)
survey_reach_edges_wgs84.list <- split(survey_reach_edges_wgs84.sf, survey_reach_edges_wgs84.sf$perc_bin)
ais_down_edges_wgs84.list     <- split(ais_down_edges_wgs84.sf, ais_down_edges_wgs84.sf$perc_bin)
survey_down_edges_wgs84.list  <- split(survey_down_edges_wgs84.sf, survey_down_edges_wgs84.sf$perc_bin)
                                       


for(i in seq_along(ais_reach_edges_wgs84.list)){
  
  
  # add edges sequentially
  caulerpa_leaflet.plot <- caulerpa_leaflet.plot %>%
    addPolylines(data = ais_reach_edges_wgs84.list[[i]],
                 color = ~reach_edge_pal(perc_bin),
                 opacity = 0.7,
                 weight = ~reach_edge_weights(perc_bin),
                 group = "AIS Reachability",
                 label = ~ paste0("From ", from, " To ", to),
                 popup = ~ paste0("From ", from, " To ", to, ", Vessels =", No_boats)) %>%
    addPolylines(data = survey_reach_edges_wgs84.list[[i]],
                 color = ~reach_edge_pal(perc_bin), 
                 opacity = 0.7,
                 weight = ~reach_edge_weights(perc_bin),
                 group = "Survey Reachability",
                 label = ~ paste0(" From ", from, " To ", to),
                 popup = ~ paste0(" From ", from, " To ", to, ", Vessels =", vessels)) %>%
    addPolylines(data = ais_down_edges_wgs84.list[[i]], 
                 weight = ~down_edge_weights(perc_bin), 
                 color = ~down_edge_pal(perc_bin),
                 opacity = 0.7,
                 group = "AIS Downstream",
                 popup = ~ paste0(" From ", from, " To ", to, ", Vessels = ", Noboats)) %>%
    addPolylines(data = survey_down_edges_wgs84.list[[i]], 
                 weight = ~down_edge_weights(perc_bin), 
                 color = ~down_edge_pal(perc_bin),
                 opacity = 0.7,
                 group = "Survey Downstream",
                  popup = ~ paste0(" From ", from, " To ", to, ", Vessels = ", vessels))
  
  
  
  
}

# Add node data
caulerpa_leaflet.plot <- caulerpa_leaflet.plot %>%
                        # Survey Reachability
                        addCircleMarkers(data = Node_leaflet_84_REM.sf2,
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#FF0000",
                                         radius = ~ reach_node_sizes(perc_bin),
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "Survey Reachability",
                                         label = ~ paste0(Cmmn_nm, ", ", Region),
                                         popup = ~ paste0(Cmmn_nm, ", ", Region)
                                         ) %>%
                        addCircleMarkers(data = survey_reach_nodes_wgs84_NRC_NOANC.sf,
                                         color = "#9C9C9C",
                                         fillColor = "#9C9C9C",
                                         radius = 3,
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "Survey Reachability",
                                         label = ~ paste0(Cmmn_nm, ", ", Region),
                                         popup = ~ paste0(Cmmn_nm, ", ", Region, "Percentage of Incoming Vessels Nationwide: ", round(Per_total, 2), "%")
                                         ) %>%
                        addCircleMarkers(data = survey_reach_nodes_wgs84_NRC_ANC.sf,
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#FF0000",
                                         radius = ~ reach_node_sizes(perc_bin),
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "Survey Reachability",
                                         label = ~ paste0(Cmmn_nm, ", ", Region),
                                         popup = ~ paste0(Cmmn_nm, ", ", Region, "Percentage of Incoming Vessels Nationwide: ", round(Per_total, 2), "%")
                                         ) %>%
                        addCircleMarkers(data = Node_leaflet_84_REM_REACH.sf,
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#0070FF",
                                         radius = 12,
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "Survey Reachability",
                                         label = ~ paste0(Cmmn_nm, ", ", Region),
                                         popup = ~ paste0(Cmmn_nm, ", ", Region, "Percentage of Incoming Vessels Nationwide: ", round(Per_total, 2), "%")
                                         ) %>%
                        # AIS Reachability
                        addCircleMarkers(data = ais_node_leaflet_84_REM.sf2,
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#FF0000",
                                         radius = ~reach_node_sizes(perc_bin),
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "AIS Reachability",
                                         label = ~ paste0(Cmmn_nm, ", ", Region),
                                         popup = ~ paste0(Cmmn_nm, ", ", Region)
                                         ) %>%
                        addCircleMarkers(data = ais_reach_nodes_wgs84_NRC_NOANC.sf,
                                         color = "#9C9C9C",
                                         fillColor = "#9C9C9C",
                                         radius = 3,
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "AIS Reachability",
                                         label = ~ paste0(Cmmn_nm, ", ", Region),
                                         popup = ~ paste0(Cmmn_nm,  ", ", Region, "Percentage of Incoming Vessels Nationwide: ", round(Perc_tot, 2), "%")
                                         ) %>%
                        addCircleMarkers(data = ais_reach_nodes_wgs84_NRC_ANC.sf,
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#FF0000",
                                         radius = ~reach_node_sizes(perc_bin),
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "AIS Reachability",
                                         label = ~ paste0(Cmmn_nm, ", ", Region),
                                         popup = ~ paste0(Cmmn_nm,  ", ", Region, "Percentage of Incoming Vessels Nationwide: ", round(Perc_tot, 2), "%")
                                         ) %>%
                        addCircleMarkers(data = ais_node_leaflet_84_REM_REACH.sf,
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#0070FF",
                                         radius = 12,
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "AIS Reachability",
                                         label = ~ paste0(Cmmn_nm, ", ", Region),
                                         popup = ~ paste0(Cmmn_nm, ", ID:", nID, ", ", Region, "Percentage of Incoming Vessels Nationwide: ", round(Perc_tot, 2), "%")
                                         ) %>%
                        # Survey Downstream
                        addCircleMarkers(data = survey_leaflet_84_5kn_REM.sf2,
                                         radius = 2,
                                         color = "#9C9C9C",
                                         opacity = 0.7,
                                         group = "Survey Downstream",
                                         popup = ~ paste0(Cmmn_nm, ", ", ", ", Region, ", Percentage of Incoming Vessels for Region: ", TON)) %>%    # Add non Northland nodes
                        addCircleMarkers(data = survey_leaflet_84_5kn_NRC_NOANC.sf,
                                         radius = 2,
                                         color = "#9C9C9C",
                                         opacity = 0.7,
                                         group = "Survey Downstream",
                                         popup = ~ paste0(Cmmn_nm,", ", Region, ", Percentage of Incoming Vessels for Region: ", per_inc, "%")) %>%             # Add non-anchorage Northland nodes
                        addCircleMarkers(data = survey_leaflet_84_5kn_REM_INF.sf,
                                         radius = 12,
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#0070FF",
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "Survey Downstream",
                                         popup = ~ paste0(Cmmn_nm,", ",  ", ", Region)) %>% # Added infected nodes
                        addCircleMarkers(data = survey_leaflet_84_5kn_NRC_OMA.sf,
                                         radius = ~down_node_sizes(perc_bin),
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#0070FF",
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "Survey Downstream",
                                         popup = ~ paste0(Cmmn_nm,", ", Region, ", Percentage of Incoming Vessels for Region: ", per_inc, "%")) %>% # adds Infected BOI node
                        addCircleMarkers(data = survey_leaflet_84_5kn_NRC_ANC.sf,
                                         radius = ~down_node_sizes(perc_bin),
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#FF0000",
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "Survey Downstream",
                                         popup = ~ paste0(Cmmn_nm,", ", Region, ", Percentage of Incoming Vessels for Region: ", per_inc, "%")) %>% # adds northland anchoring nodes
                        # AIS Downstream
                        addCircleMarkers(data = ais_leaflet_84_5kn_REM.sf2,
                                         radius = 2,
                                         color = "#9C9C9C",
                                         opacity = 0.7,
                                         group = "AIS Downstream",
                                         popup = ~ paste0(Cmmn_nm, ", ", Region, ", Percentage of Incoming Vessels for Region: ", Perc_tot)) %>%    # Add non Northland nodes
                        addCircleMarkers(data = ais_leaflet_84_5kn_NRC_NOANC.sf,
                                         radius = 1,
                                         color = "#9C9C9C",
                                         opacity = 0.7,
                                         group = "AIS Downstream",
                                         popup = ~ paste0(Cmmn_nm, ", ", Region, ", Percentage of Incoming Vessels for Region: ", Perc_tot)) %>%             # Add non-anchorage Northland nodes
                        addCircleMarkers(data = ais_leaflet_84_5kn_REM_INF.sf,
                                         radius = 12,
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#0070FF",
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "AIS Downstream",
                                         popup = ~ paste0(Cmmn_nm,", ", Region)) %>% # Added infected nodes
                        addCircleMarkers(data = ais_leaflet_84_5kn_NRC_ANC.sf,
                                         radius = ~down_node_sizes(perc_bin),
                                         color = "black",
                                         weight = 0.5,
                                         fillColor = "#FF0000",
                                         opacity = 0.7,
                                         fillOpacity = 0.7,
                                         group = "AIS Downstream",
                                         popup = ~ paste0(Cmmn_nm, ", ", Region, ", Percentage of Incoming Vessels for Region: ", Perc_tot))  # adds northland anchoring nodes              
                        

# caulerpa_leaflet.plot <- caulerpa_leaflet.plot %>%
#   onRender(
#     sprintf("
#     function(el, x) {
#       var reachLegend = L.control({position: 'bottomright'});
#       reachLegend.onAdd = function(map) {
#         var div = L.DomUtil.create('div', 'info legend');
#         div.innerHTML = `%s`;
#         return div;
#       };
# 
#       var downLegend = L.control({position: 'bottomright'});
#       downLegend.onAdd = function(map) {
#         var div = L.DomUtil.create('div', 'info legend');
#         div.innerHTML = `%s`;
#         return div;
#       };
# 
#       // --- Add initial legend(s) for already-active overlays ---
#       var map = this;
#       map.eachLayer(function(layer) {
#         if (layer.options && layer.options.group === 'AIS Reachability' || layer.options.group === 'Survey Reachability') {
#           reachLegend.addTo(map);
#         }
#         if (layer.options && layer.options.group === 'AIS Downstream' || layer.options.group === 'Survey Downstream') {
#           downLegend.addTo(map);
#         }
#       });
# 
#       // --- Toggle legends when overlays are switched ---
#       map.on('overlayadd', function(e) {
#         if (e.name === 'AIS Reachability' || e.name === 'Survey Reachability') {
#           reachLegend.addTo(map);
#         }
#         if (e.name === 'AIS Downstream' || e.name === 'Survey Downstream') {
#           downLegend.addTo(map);
#         }
#       });
# 
#       map.on('overlayremove', function(e) {
#         if (e.name === 'AIS Reachability' || e.name === 'Survey Reachability') {
#           map.removeControl(reachLegend);
#         }
#         if (e.name === 'AIS Downstream' || e.name === 'Survey Downstream') {
#           map.removeControl(downLegend);
#         }
#       });
#     }
#     ",
#     gsub("\n", "", reachability_legend),
#     gsub("\n", "", downstream_legend)
#     )
#   )

caulerpa_leaflet.plot <- caulerpa_leaflet.plot %>%
  htmlwidgets::onRender(sprintf("
    function(el, x) {
      var map = this;

      // --- Define four legends (one per base group) ---
      var surveyReach = L.control({position: 'bottomright'});
      surveyReach.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = `%s`;
        return div;
      };

      var aisReach = L.control({position: 'bottomright'});
      aisReach.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = `%s`;
        return div;
      };

      var surveyDown = L.control({position: 'bottomright'});
      surveyDown.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = `%s`;
        return div;
      };

      var aisDown = L.control({position: 'bottomright'});
      aisDown.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = `%s`;
        return div;
      };

      // --- Helper: show the right legend ---
      function updateLegend(groupName) {
        try { map.removeControl(surveyReach); } catch(e){}
        try { map.removeControl(aisReach); } catch(e){}
        try { map.removeControl(surveyDown); } catch(e){}
        try { map.removeControl(aisDown); } catch(e){}

        if (groupName === 'Survey Reachability') {
          surveyReach.addTo(map);
        } else if (groupName === 'AIS Reachability') {
          aisReach.addTo(map);
        } else if (groupName === 'Survey Downstream') {
          surveyDown.addTo(map);
        } else if (groupName === 'AIS Downstream') {
          aisDown.addTo(map);
        }
      }

      // --- Detect initial visible base layer (like your working version) ---
      var initialGroup = null;
      for (var id in map._layers) {
        var lyr = map._layers[id];
        if (lyr && lyr.options && lyr.options.group && map.hasLayer(lyr)) {
          initialGroup = lyr.options.group;
          break;
        }
      }
      if (initialGroup) updateLegend(initialGroup);

      // --- Update when user toggles the base layer ---
      map.on('baselayerchange', function(e) {
        updateLegend(e.name);
      });
    }
  ",
  gsub("\n", "", survey_reachability_legend),
  gsub("\n", "", ais_reachability_legend),
  gsub("\n", "", survey_downstream_legend),
  gsub("\n", "", ais_downstream_legend)
  ))







caulerpa_leaflet.plot

# save the plot as self contained html

if(write_outputs){
  
  saveWidget(caulerpa_leaflet.plot, 
             file = file.path(figure_directory, "caulerpa_leaflet_v2.html"), 
             selfcontained = TRUE)
  
  message("Caulerpa leaflet map saved to ", file.path(figure_directory, "caulerpa_leaflet_v2.html"))
}





```




